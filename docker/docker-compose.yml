version: '3.8'

services:
  # --- WEAVIATE STANDALONE ---
  weaviate:
    image: semitechnologies/weaviate:1.27.0
    container_name: weaviate_db
    ports:
      - "8080:8080"
      - "50051:50051"
    volumes:
      - weaviate_data:/var/lib/weaviate
    restart: on-failure:0
    environment:
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      # Crucial: Ensures you handle vectorization (embedding) in your code
      DEFAULT_VECTORIZER_MODULE: 'none' 
      ENABLE_MODULES: ''
      CLUSTER_HOSTNAME: 'weaviate_db'
      
  # --- MILVUS STANDALONE AND ITS DEPENDENCIES ---
  milvus-etcd:
    image: quay.io/coreos/etcd:v3.5.0
    container_name: milvus-etcd
    environment:
      - ETCD_AUTO_COMPACTION_MODE=revision
      - ETCD_AUTO_COMPACTION_RETENTION=1000
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://0.0.0.0:2379
    volumes:
      - milvus_etcd:/etcd
    healthcheck:
      test: ["CMD", "etcdctl", "get", "/health"]
      interval: 30s
      timeout: 20s
      retries: 3

  milvus-minio:
    image: minio/minio:latest 
    container_name: milvus-minio
    environment:
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
    command: minio server /minio_data
    volumes:
      - milvus_minio:/minio_data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3
    
  milvus-standalone:
    image: milvusdb/milvus:v2.4.9
    container_name: milvus_db
    command: ["milvus", "run", "standalone"]
    ports:
      - "19530:19530"
      - "9091:9091" 
    environment:
      ETCD_ENDPOINTS: milvus-etcd:2379
      MINIO_ADDRESS: milvus-minio:9000
    volumes:
      - milvus_data:/var/lib/milvus
    depends_on:
      milvus-etcd:
        condition: service_healthy
      milvus-minio:
        condition: service_healthy

volumes:
  weaviate_data:
  milvus_data:
  milvus_etcd:
  milvus_minio:
